---
title: Deploying Deep Learning Models with CloudML
author: ''
date: '2018-11-28'
slug: deploying-deep-learning-models-with-cloudml
categories:
  - R
tags:
  - deep learning
  - keras
  - cloudml
---



<p>In this post we will go over deploying deep learning models to Google’s <a href="https://cloud.google.com/ml-engine/">cloud machine learning engine</a> in R with the <code>keras</code> and <code>cloudml</code> packages.</p>
<p>The <code>cloudml</code> package built by the good people of RSudio allows us to train deep learning models built with <code>keras</code> and <code>tensorflow</code> in the cloud. It also allows the deployment of trained models to the Google global prediction platform, which we can use to make predictions with a simple API call.</p>
<div id="getting-started-with-google-cloud" class="section level2">
<h2>Getting started with Google Cloud</h2>
<p>Before you can begin training models with CloudML you need to have a Google Cloud Account. If you don’t already have an account you can create one at <a href="https://console.cloud.google.com" class="uri">https://console.cloud.google.com</a>.</p>
<p>The account creation process will lead you through creating a new project. To enable the Machine Learning API for this project navigate to the “ML Engine” menu on the left. Doing this for the first time will enable the ML API and allow you to submit ML jobs.</p>
</div>
<div id="installing-the-cloudml-package" class="section level2">
<h2>Installing the <code>cloudml</code> package</h2>
<p>Install the <code>cloudml</code> package from CRAN as follows:</p>
<pre class="r"><code>install.packages(&quot;cloudml&quot;)</code></pre>
<p>You’ll need to install the Google Cloud SDK, a set of utilties that enable you to interact with your Google Cloud account from within R. You can install the SDK using the <code>gcloud_install()</code> function.</p>
<pre class="r"><code>library(cloudml)
# gcloud_install() -- I&#39;ve already done this step</code></pre>
<p>Note that in order to ensure that the <code>cloudml</code> package can find your installation of the SDK you should accept the default installation location (~/) suggested within the installer.</p>
<p>As part of the installation you are asked to specify a default account, project, and compute region for Google Cloud. These settings are then used automatically for all CloudML jobs. To change the default account, project, or region you can use the <code>gcloud_init()</code> function.</p>
</div>
<div id="training-a-model-on-cloudml" class="section level2">
<h2>Training a model on CloudML</h2>
<p>Let’s say that we have already built a keras model in a file called <code>tagger.R</code>. All of the code in this file can be seen below.</p>
<pre class="r"><code># load packages
library(keras)
library(cloudml)


# data collection ---------------------------------------------------------

# load messages
messages &lt;- readRDS(&quot;clean_hs_messages.rds&quot;)

# load data for training
one_hot_results &lt;- readRDS(&quot;hs_one_hot_results.rds&quot;)

# load labels
label_matrix &lt;- readRDS(&quot;hs_label_matrix.rds&quot;)


# data partitioning -------------------------------------------------------

# set maximimum number of words to consider
max_words &lt;- 10000

# define labels
labels &lt;- as.numeric(as.factor(messages$custom_field_label)) - 1

# get number of distinct labels
num_classes &lt;- max(labels) + 1

# split data into training and testing sets
indices &lt;- sample(1:nrow(messages))

# define number of training samples
training_samples = round(nrow(messages) * 0.7, 0)
validation_samples = nrow(messages) - training_samples

# set training and testing indeces
training_indices &lt;- indices[1:training_samples]
validation_indices &lt;- indices[(training_samples + 1): (training_samples + validation_samples)]

# create training set
x_train &lt;- one_hot_results[training_indices,]
y_train &lt;- label_matrix[training_indices,]

# create validation set
x_val &lt;- one_hot_results[validation_indices,]
y_val &lt;- label_matrix[validation_indices,]


# model building ----------------------------------------------------------


model &lt;- keras_model_sequential() %&gt;% 
  layer_dense(units = 32, activation = &quot;relu&quot;, input_shape = c(max_words)) %&gt;% 
  layer_dropout(rate = 0.3) %&gt;% 
  layer_dense(units = 32, activation = &quot;relu&quot;) %&gt;% 
  layer_dropout(rate = 0.2) %&gt;% 
  layer_dense(units = num_classes) %&gt;% 
  layer_activation(activation = &#39;softmax&#39;)

model %&gt;% compile(
  optimizer = &quot;rmsprop&quot;,
  loss = &quot;categorical_crossentropy&quot;,
  metrics = c(&quot;accuracy&quot;)
)

model %&gt;% fit(
  one_hot_results, label_matrix,
  batch_size = 256,
  epochs = 10,
  verbose = 1,
  validation_split = 0.3
)</code></pre>
<p>Once we’ve onfirmed that things work as expected locally, we can submit a CloudML job to perform training in the cloud with the <code>cloud_train()</code> function. In our case we would run the following:</p>
<pre class="r"><code># train the helpscout tagger model
tagger_job &lt;- cloudml_train(&quot;tagger.R&quot;)</code></pre>
<p>All of the files within the current working directory will be bundled up and sent along with the script to CloudML. The <code>cloudml</code> package discovers all the dependencies (<code>dplyr</code>, etc) and uses <code>packrat</code> to get the corresponding packages and install those on the CloudML service.</p>
<p>Note that the very first time you submit a job to CloudML the various packages required to run your script will be compiled from source. This will make the execution time of the job considerably longer that you might expect. It’s only the first job that incurs this overhead though (since the package installations are cached), and subsequent jobs will run more quickly.</p>
<p>The status of the job can be viewed in the RStudio console:</p>
<div class="figure">
<img src="/post/2018-11-28-deploying-deep-learning-models-with-cloudml_files/Screen%20Shot%202018-11-28%20at%201.00.13%20PM.png" style="width:100.0%" />

</div>
<p>You can use the link in the R console to view the job in the Google Cloud Platform.</p>
<div class="figure">
<img src="http://hi.buffer.com/cbbb1c7d992b/Screen%252520Recording%2525202018-11-28%252520at%25252003.20%252520PM.gif" style="width:100.0%" />

</div>
<p>You can also view the logs from this page.</p>
</div>
<div id="collecting-results" class="section level2">
<h2>Collecting Results</h2>
<p>When the job is complete, training results can be collected back to your local system (this is done automatically when monitoring the job using a background terminal in RStudio). A run report is displayed after the job is collected:</p>
<div class="figure">
<img src="/post/2018-11-28-deploying-deep-learning-models-with-cloudml_files/Screen%20Shot%202018-11-28%20at%202.11.13%20PM.png" style="width:100.0%" />

</div>
</div>
<div id="deploying-the-model" class="section level2">
<h2>Deploying the Model</h2>
<p>You can host your trained machine learning models in the cloud and use the Cloud ML prediction service to make predictions for new data. The Cloud ML prediction service makes use of models exported through the <code>export_savedmodel()</code> function.</p>
<p>Once we have trained our model, we can export it with the following command:</p>
<pre class="r"><code>export_savedmodel(model, &quot;helpscoutTagger&quot;)</code></pre>
<p>Deployment is performed through <code>cloudml_deploy()</code> which uses the same gcloud and cloudml configuration concepts used while training. We can train any exported model by running:</p>
<pre class="r"><code>cloudml_deploy(&quot;helpscoutTagger&quot;, name = &quot;helpscout_tagger&quot;)</code></pre>
<p>Once the models are registered, they are available in a central repository for your organization to consume and maintain. You can view the models in the “Models” section of the Google Cloud Platform. From here you can also monitor all the calls to the model, so that you can understand how the models are being used.</p>
<div class="figure">
<img src="http://hi.buffer.com/7e8f0e3820d8/Screen%252520Recording%2525202018-11-28%252520at%25252003.24%252520PM.gif" style="width:100.0%" />

</div>
</div>
<div id="prediction" class="section level2">
<h2>Prediction</h2>
<p>Once a model is deployed, predictions can be performed by providing a list of inputs into <code>cloudml_predict()</code>. Note that none of the code above has actually been executed. We’ll try to make predictions in this session simply by providing a new input to the deployed model.</p>
<pre class="r"><code>library(keras)

# load tokenizer
tokenizer &lt;- load_text_tokenizer(&#39;helpscout_tokenizer&#39;)

# explicitly name labels
label_names &lt;- c(&#39;analytics&#39;, &#39;API&#39;, &#39;billing&#39;, &#39;composing&#39;, &#39;extension&#39;, 
                 &#39;feature request&#39;, &#39;Instagram&#39;, &#39;onboarding&#39;,&#39;org-maintenance&#39;,
                 &#39;posting&#39;, &#39;profile-connection&#39;,&#39;profile-maintenance&#39;, 
                 &#39;reply-support&#39;, &#39;scheduling&#39;, &#39;social media advice&#39;,
                 &#39;uncategorized&#39;, &#39;user-authorization&#39;, &#39;user-maintenance&#39;)


# set new text to predict labels for 
new_text &lt;- &quot;my Instagram profile keeps getting disconnected&quot;

# one-hot encode the text
one_hot &lt;- texts_to_matrix(tokenizer, as.array(new_text), mode = &quot;binary&quot;)

# make predictions
cloudml_predict(list(as.vector(t(one_hot))),
  name = &quot;helpscout_tagger&quot;,
)</code></pre>
<pre><code>## $activation_1
##  [1] 0.007244328 0.003970789 0.004765628 0.022719393 0.012489572
##  [6] 0.009120903 0.061196748 0.016898876 0.020834390 0.125537947
## [11] 0.382040441 0.133156627 0.002006179 0.021518936 0.006911561
## [16] 0.103776142 0.027197013 0.038614459</code></pre>
<p>We have a set of predictions that we can associate with the label names!</p>
<p>Documentation More documentation on model deployment can be found on <a href="https://tensorflow.rstudio.com/tools/cloudml/articles/deployment.html">RStudio’s site</a>. You can find more information about training models in the cloud <a href="https://tensorflow.rstudio.com/tools/cloudml/articles/training.html">here</a>.</p>
</div>
